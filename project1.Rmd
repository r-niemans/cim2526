---
title: "Project 1"
author: "Rafke"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Project 1

Code to guide answers from Project 1. 

```{r import}
library("DAAG")
library(bootstrap)
library(questionr) 
library(dplyr)
library(ggplot2)
library(MASS)
library(grid)
data(nassCDS)
names(nassCDS)
data <- na.omit(nassCDS)
data <- nassCDS[, c("dead", "yearVeh")]
str(data)
data$dead <- factor(data$dead, levels = c("alive","dead"), labels = c("0","1"))

```

### Question 1 

Let Y_i be an indicator variable which takes the value of 1 if an occupant died in an accident (the variable
dead) and zero otherwise and let X_i be the year of model of the vehicle (=the year that the car was produced,
the variable yearVeh). We consider the following GLM:\\ 

$$g(P(Y_i = 1 | X_i)) = β_0 + β_1X_i.$$ with $$g(p) = log (\frac{p}{1-p})$$
1. Estimate the model using the classical GLM approach.
```{r}
dead_n <- length(data$dead[data$dead==1])
dead <- as.integer(as.character(data$dead))
total_n <- nrow(data)
proportiondead <-dead/total_n
alive <-total_n-dead

dead_by_year  <- tapply(dead, data$yearVeh, sum, na.rm = TRUE)
total_by_year <- tapply(dead, data$yearVeh, length)
alive_by_year <- total_by_year - dead_by_year
prop_by_year  <- dead_by_year / total_by_year

year <- as.numeric(names(prop_by_year))
par(mfrow=c(1,1))
plot(year, prop_by_year,
     main="Proportion of people dying in a car accident",
     ylim=c(0,1), xlab="Year", ylab="Proportion dead")

fit.accidents <- glm(cbind(dead_by_year, alive_by_year) ~ year,
                     family = binomial(link="logit"))

ord <- order(year)
lines(year[ord], fitted(fit.accidents)[ord])
```

The plot suggests that the **proportion of occupants who died decreases as vehicle model year increases**. Older vehicles (roughly the 1950s–1970s) show higher and more variable death proportions, while for newer model years (around the mid-1980s onward) the death proportion is **low and fairly stable**, close to zero. The fitted logistic trend line slopes downward, indicating a **negative association** between vehicle year and the probability of death—consistent with improved vehicle safety in newer cars.

Distribution of the response $$Y \sim B(1,\pi_{ij})$$
Systematic part $$\eta_i= \beta_0 + \beta_1 \times yearVeh_i$$

2. Let X_10 be the car’s year for which the probability to die is 0.1, P(Y_i = 1) = 0.1. Estimate X_10. Use
non parametric bootstrap to estimate the distribution of X10 and construct a 95% confidence interval
for the _10.

We resample row indices/ bootstrap coefficients $$\beta_0, \beta_1$$ and then estimate the distribution by means of nonparametric bootstrapping results for both $$\beta$$ values.

```{r}
y <- as.integer(as.character(data$dead))
x <- data$yearVeh

B <- 2000
n <- nrow(data)

beta0 <- numeric(B)
beta1 <- numeric(B)

for (b in 1:B) {
  idx <- sample.int(n, n, replace=TRUE)
  fit_b <- glm(y[idx] ~ x[idx], family=binomial(link="logit"))
  beta_coefs<- coef(fit_b)
  beta0[b] <- beta_coefs[1]
  beta1[b] <- beta_coefs[2]
}

prob01 <- log(0.1/0.9)
X10 <- (prob01 - beta0) / beta1

```

```{r}
par(mfrow=c(1,2))
hist(beta0,nclass=50)
hist(beta1,nclass=50)
hist(X10, nclass=50)

quantile(X10, c(0.025, 0.975), na.rm=TRUE)
```

$$\beta_1 < 0$$ means: as vehicle year increases, the log-odds of dying decrease, so the probability of death goes down for newer model years.

The histogram implies that cars around the early 1970s (~ 1971-1973) correspond to a 10% death probability.

3. For the model formulated above, we focus on the odds ratio (OR) for a unit increased of the year in
which the car was produced. Estimate the OR and use parametric bootstrap to test the null hypothesis
H0 : OR= 1.

```{r}
y <- data$dead
x <- data$yearVeh
glm.fit <- glm(y ~ x, family = binomial(link="logit"), data = data)
OR_hat <- exp(coef(glm.fit)[2])
OR_hat

fit_null <- glm(y ~ 1, family=binomial)
p0 <- fitted(fit_null)[1]   

set.seed(33)
B <- 2000
n <- length(y)
OR_b <- numeric(B)

for (b in 1:B) {
  yb <- rbinom(n, 1, p0)                 # H0
  fit_b <- glm(yb ~ x, family=binomial)  # and then full model
  OR_b[b] <- exp(coef(fit_b)[2])
}

p_val <- mean(abs(log(OR_b)) >= abs(log(OR_hat)))
p_val
```

4. Consider a car that was produced in 1996. Let $$π_1996$$ be the probability to die when driving a car that
was produced in 1996. Estimate $$π_1996$$ and construct a 95% confidence interval for $$π_1996$$.

```{r}
set.seed(33)
B <- 2000
n <- nrow(data)

pi1996_b <- numeric(B)

for (b in 1:B) {
  idx <- sample.int(n, n, replace=TRUE)
  fit_b <- glm(dead ~ yearVeh, family=binomial(link="logit"), data=data[idx, ])
  pi1996_b[b] <- predict(fit_b, newdata=data.frame(yearVeh=1996), type="response")
}

fit <- glm(dead ~ yearVeh, family=binomial, data=data)
pi_hat <- predict(fit, newdata=data.frame(yearVeh=1996), type="response")
CI <- quantile(pi1996_b, c(0.025, 0.975), na.rm=TRUE)

pi_hat
CI
```
The estimated probability of dying in an accident when driving a car produced in 1996 is about 3.6–4.1% (CI 95%), hinting at a relatively small uncertainty.

## Question 2

In this question we focus on the age of the age of occupant in years (the variable ageOFocc) and the injury severity (the variable injSeverity). For the analysis, select only observations for which injSeverity is smaller than 5. Note that, after filtering, the variable injSeverity is a numerical variable with the values: 
- 0 = none
- 1 = possible injury
- 2 = no incapacity
- 3 = incapacity
- 4 = killed

1. Calculate the mean age by injury severity.

```{r}
severity_subset <- na.omit(subset(nassCDS, injSeverity < 5, select = c(ageOFocc, injSeverity)))
severity_subset <- na.omit(severity_subset)

severity_subset$injSeverity <- factor(severity_subset$injSeverity,
                        levels = 0:4,
                        labels = c("None","Possible injury","No incapacity","Incapacity","Killed"))

tapply(severity_subset$ageOFocc, severity_subset$injSeverity, mean)
```


```{r}
severity_subset$injSeverity <- factor(severity_subset$injSeverity)

# Summarize mean + 95% CI by group
sum_df <- severity_subset %>%
  group_by(injSeverity) %>%
  summarise(
    mean = mean(ageOFocc, na.rm = TRUE),
    n    = sum(!is.na(ageOFocc)),
    sd   = sd(ageOFocc, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    se   = sd / sqrt(n),
    tcr  = qt(0.975, df = n - 1),
    lower = mean - tcr * se,
    upper = mean + tcr * se
  )

boxplot_meanage <- ggplot(sum_df, aes(x = injSeverity, y = mean)) +
  geom_errorbar(aes(ymin = lower, ymax = upper),
                width = 0.15, linewidth = 0.7) +
  geom_point(size = 2.6) +
  labs(
    title = "Mean occupant age by injury severity",
    subtitle = "95% confidence intervals",
    x = "injSeverity",
    y = "Mean ageOFocc"
  ) +
  theme_bw(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(color = "grey30"),
    panel.grid.major = element_line(linewidth = 0.3),
    panel.grid.minor = element_line(linewidth = 0.2),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

boxplot_meanage
```

2. Use a non parametric bootstrap procedure to test the null hypothesis mean age of the occupant is equal across all injury severity groups.



```{r}
fit_obs <- aov(ageOFocc ~ injSeverity, data = severity_subset)
F_obs <- summary(fit_obs)[[1]][["F value"]][1]

set.seed(33)
boot <- 1000
n <- nrow(severity_subset)
F_boot <- numeric(boot)

for (b in 1:boot) {
  d_b <- severity_subset
  d_b$injSeverity <- sample(d_b$injSeverity, replace = FALSE)
  fit_b <- aov(ageOFocc ~ injSeverity, data = d_b)
  F_boot[b] <- summary(fit_b)[[1]][["F value"]][1]
}

p_val <- (1 + sum(F_boot >= F_obs, na.rm=TRUE)) / (B + 1)
c(F_obs = F_obs, p_value = p_val)
```



3. Let µnone and µkilled be the mean age of occupant for the groups with injury severity “None” and
“Killed”, respectively. Use parametric bootstrap to estimate a 95% confidence interval for the difference
µnone−µkilled.

First, let's check the distribution. 

```{r}

g_none <- glm(x_none ~ 1, family = Gamma(link="log"))
g_k    <- glm(x_killed ~ 1, family = Gamma(link="log"))

x_none   <- severity_subset$ageOFocc[severity_subset$injSeverity == "None"]
x_killed <- severity_subset$ageOFocc[severity_subset$injSeverity == "Killed"]

df_long <- rbind(
  data.frame(group = "None",   age = x_none),
  data.frame(group = "Killed", age = x_killed)
)

df_long <- subset(df_long, is.finite(age))

ggplot(df_long, aes(x = age, fill = group)) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 30,
                 color = "white",
                 alpha = 0.75) +
  geom_density(aes(color = group), linewidth = 1, fill = NA) +
  facet_wrap(~ group, nrow = 1, scales = "free_y") +
  scale_fill_manual(values = c("None" = "#6475ED", "Killed" = "#FF8C00")) +
  scale_color_manual(values = c("None" = "#6495ED", "Killed" = "#FF8C70")) +
  labs(title = "Age distributions by injury severity",
       x = "Age", y = "Density") +
  theme_minimal(base_size = 14) +
  theme(strip.text = element_text(face = "bold"),
        plot.title = element_text(face = "bold"),
        legend.position = "none")

```

Right-skewed and we are dealing with continuous data (since it concerns the age) hence
this implies a Gamma distribution. We need to fit a Gamma distribution and use the fitted residuals including the shape (alpha) and rate (beta). These two numbers completely determine the Gamma distribution (under the shape–rate parameterization). In the parametric bootstrap we plug in those estimated parameters and treat the fitted Gamma as our model for how ages were generated.

```{r}

fit_gamma_none   <- fitdistr(x_none,   "gamma")   # returns shape and rate
fit_gamma_killed <- fitdistr(x_killed, "gamma")

fit_gamma_none
fit_gamma_killed

B <- 20000                  
diffs <- numeric(B)

shape_none <- as.numeric(fit_gamma_none$estimate["shape"])
rate_none  <- as.numeric(fit_gamma_none$estimate["rate"])
shape_kill <- as.numeric(fit_gamma_killed$estimate["shape"])
rate_kill  <- as.numeric(fit_gamma_killed$estimate["rate"])

for(b in 1:B){
  samp_none   <- rgamma(n_none,  shape = shape_none,  rate = rate_none)
  samp_killed <- rgamma(n_killed, shape = shape_kill,  rate = rate_kill)
  diffs[b] <- mean(samp_none) - mean(samp_killed)
}

ci <- quantile(diffs, probs = c(0.025, 0.975))
mean_diff_boot <- mean(diffs)

cat("Parametric bootstrap mean difference =", round(mean_diff_boot,3), "\n")
cat("95% parametric-bootstrap percentile CI for mu_none - mu_killed:\n")
print(round(ci,3))

hist(diffs, breaks=60, main = expression("Parametric bootstrap distribution of the mean age difference " *
                       (mu[none] - mu[killed])),
     xlab = expression(mu[none] - mu[killed]))
abline(v = ci, col = "red", lwd=2)
abline(v = mean_diff_boot, col = "blue", lwd=2)
legend("topright", legend=c("95% CI","bootstrap mean"), col=c("red","blue"), lwd=2)
```
Negative result interval indicated that 'None' injury severity group are younger on average than 'Killed' group occupants. Difference is 7.5-10 years.

## Question 3 

In this question we focus of the following 2 ×2 table (for the complete case analysis) for the variables seat
belt usage (the variable seatbelt) and the accident outcome (the variable dead).

```{r}
data <- na.omit(nassCDS)
seatbelt_subset <- data[, c("seatbelt","dead")]
tab <- table(seatbelt_subset$seatbelt, seatbelt_subset$dead)
tab 
```

1. Define the observation unit (Xi,Yi) for the question.
$$
Y_{ij}\in\{0,1\}
\quad\text{and}\quad
\pi = P(Y=1).
$$

```{r}
xi <- seatbelt_subset$seatbelt
y <- seatbelt_subset$dead
```

2. Calculate the odds ratio for usage of seat belt and accident outcome (dead/alive) and construct a 95%
confidence interval for the OR. You can use the R function oddsratio. What is your conclusion ? Do
you think that usage of seat belt influences the accident outcome ?

```{r}
OR <- (500/17965) / (680/6918) 
OR
```

Since the OR is well below 1, wearing a seatbelt is associated with lower odds of death.

Numerically, an OR of 0.28 means the odds of dying for belted occupants are about 72% lower than for unbelted occupants 
(1-0.283 = 0.717).

3. Use non-parametric bootstrap to construct a 95%
confidence interval for the OR.

```{r}
set.seed(33)

alive_none  <- 6918
dead_none   <- 680
alive_belt  <- 17965
dead_belt   <- 500

OR_hat <- (dead_belt / alive_belt) / (dead_none / alive_none)


B <- 20000
N <- alive_none + dead_none + alive_belt + dead_belt
p <- c(alive_none, dead_none, alive_belt, dead_belt) / N

boot_counts <- rmultinom(B, size = N, prob = p)
an <- boot_counts[1,]
dn <- boot_counts[2,]
ab <- boot_counts[3,]
db <- boot_counts[4,]

OR_boot <- (db / ab) / (dn / an)

CI <- quantile(OR_boot, c(0.025, 0.975), na.rm = TRUE)

c(OR = OR_hat, CI_low = CI[1], CI_high = CI[2])


```

4. Use parametric bootstrap to test the hypothesis that usage of seat belt does not influence the accident
outcome using a chi-square test for a 2 ×2 table.

```{r}
tab <- table(seatbelt_subset$seatbelt, seatbelt_subset$dead)

chisq_obs <- suppressWarnings(chisq.test(tab, correct = FALSE)$statistic)

set.seed(33)
B <- 10000
n_tot <- sum(tab)

p_row <- prop.table(tab, 1) %*% c(1,1)  
p_col <- c(1,1) %*% prop.table(tab, 2)
p_cell <- as.vector(p_row %o% p_col)      

chisq_star <- numeric(B)

for (b in 1:B) {
  tt_vec <- as.vector(rmultinom(1, size = n_tot, prob = p_cell))
  tt <- matrix(tt_vec, nrow = 2, byrow = FALSE)
  dimnames(tt) <- dimnames(tab)
  chisq_star[b] <- suppressWarnings(chisq.test(tt, correct = FALSE)$statistic)
}


p_val <- (1 + sum(chisq_star >= chisq_obs, na.rm = TRUE)) / (B + 1)

c(chisq_obs = chisq_obs, p_value = p_val)

```


## Question 4 

In this question we focus on the variables: usage of seat belt (the variable seatbelt) and gender (the variable
sex).
1. Estimate the proportion of male (πM ) and female (πF ) who used seat belt.

```{r}
sex_df <- na.omit(nassCDS[c('sex','seatbelt')])
table(sex_df$sex, sex_df$seatbelt)
prop.table(table(sex_df$sex, sex_df$seatbelt), margin = 1)
```

2. Test the hypothesis that the proportion of male and female that use seat belt are equal using a classical
two-samples test.
```{r}
set.seed(33)
B <- 1000

f_none   <- 2863
f_belted <- 9385
m_none   <- 4781
m_belted <- 9188

nF <- f_none + f_belted
nM <- m_none + m_belted

x <- c(rep(1, f_belted), rep(0, f_none))
y <- c(rep(1, m_belted), rep(0, m_none))
z <- c(x, y)
mn <- length(z)

t.obs <- as.numeric(t.test(x, y)$statistic)
t.obs
```

3. Use non parametric bootstrap to test the hypothesis that the proportion of male and female that use
seat belt in an accidents are equal.

```{r}
set.seed(33)
B <- 2500
f_none   <- 2863
f_belted <- 9385
m_none   <- 4781
m_belted <- 9188
nF <- f_none + f_belted
nM <- m_none + m_belted
x <- c(rep(1, f_belted), rep(0, f_none))
y <- c(rep(1, m_belted), rep(0, m_none))
t.obs <- as.numeric(t.test(x, y)$statistic)
t.boot <- numeric(B)
for (b in seq_len(B)) {
  z.b <- sample(z, size = mn, replace = TRUE)
  x.b <- z.b[1:nF]
  y.b <- z.b[(nF + 1):mn]
  t.boot[b] <- as.numeric(t.test(x.b, y.b)$statistic)
}

#monte carlo p-value
Pmc <- (1 + sum(t.boot > t.obs)) / (B + 1)
diff.boot <- numeric(B)
for (b in seq_len(B)) {
  z.b <- sample(z, size = mn, replace = TRUE)
  x.b <- z.b[1:nF]
  y.b <- z.b[(nF + 1):mn]
  diff.boot[b] <- mean(x.b) - mean(y.b)
}

ci_boot <- quantile(diff.boot, probs = c(0.025, 0.975))
cat("Observed t-statistic:", t.obs, "\n")
cat("Pmc (one-sided, upper):", Pmc, "\n")
cat("Non-parametric bootstrap 95% percentile CI for (pi_F - pi_M):", ci_boot[1], "to", ci_boot[2], "\n")
hist(diff.boot, breaks = 40, main = expression("Non-parametric bootstrap distribution of " ~ hat(pi)[F] - hat(pi)[M]), xlab = expression(hat(pi)[F] - hat(pi)[M]))
abline(v = mean(diff.boot), col = "blue", lwd = 2)
abline(v = ci_boot, col = "darkgreen", lwd = 2, lty = 2)

```

4. Use parametric bootstrap construct a 95% confident interval for πM−πF.

```{r warning=FALSE}
set.seed(33)
B <- 20000
f_none   <- 2863
f_belted <- 9385
m_none   <- 4781
m_belted <- 9188
nF <- f_none + f_belted
nM <- m_none + m_belted
pF_hat <- f_belted / nF
pM_hat <- m_belted / nM
diff.boot <- numeric(B)
for (b in seq_len(B)) {
  xF_sim <- rbinom(1, nF, pF_hat)
  xM_sim <- rbinom(1, nM, pM_hat)
  diff.boot[b] <- (xM_sim / nM) - (xF_sim / nF)   # pi_M - pi_F
}

ci_param <- quantile(diff.boot, probs = c(0.025, 0.975))
obs_diff <- pM_hat - pF_hat

print(c(ci_param, obs_diff))

dens <- density(diff.boot)
ymax <- max(dens$y)
y_obs <- approx(dens$x, dens$y, xout = obs_diff)$y
df <- data.frame(diff = diff.boot)

ggplot(df, aes(x = diff)) +
  geom_histogram(aes(y = after_stat(density)), bins = 80, fill = "#6495ED", alpha = 0.6, color = NA) +
  geom_line(data = data.frame(x = dens$x, y = dens$y), aes(x = x, y = y), color = "#FF8C00", size = 1) +
  geom_vline(xintercept = obs_diff, linetype = "dashed", size = 1, color = "black") +
  geom_vline(xintercept = ci_param[1], linetype = "dotted", size = 1, color = "darkgreen") +
  geom_vline(xintercept = ci_param[2], linetype = "dotted", size = 1, color = "darkgreen") +
  geom_segment(aes(x = obs_diff, xend = obs_diff, y = y_obs + ymax*0.02, yend = y_obs + ymax*0.08),
               color = "black", size = 0.6) +
  geom_label(aes(x = obs_diff, y = y_obs + ymax*0.095, 
                 label = sprintf("Observed\n%.4f", obs_diff)),
             fill = "white", label.size = 0.2, size = 3, hjust = 0.5) +
  annotate("text", x = ci_param[1], y = ymax * 0.62, label = sprintf("%.4f", ci_param[1]), hjust = 0.5, size = 3) +
  annotate("text", x = ci_param[2], y = ymax * 0.62, label = sprintf("%.4f", ci_param[2]), hjust = 0.5, size = 3) +
  labs(
    title = expression("Parametric bootstrap: " ~ pi[M] - pi[F] ~ "(B = 20000)"),
    x = expression(pi[M] - pi[F]),
    y = "Density"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    plot.margin = unit(c(1, 1, 1.5, 1), "lines"),
    panel.grid.minor = element_blank()
  ) +
  coord_cartesian(clip = "off")
```

